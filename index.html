<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniExtract Pro - Indian Mobile OCR</title>
    <!-- External Libraries via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar { transition: width 0.3s ease; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl text-white">
                    <i data-lucide="smartphone" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900">OmniExtract Pro</h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Local Offline OCR Engine</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button id="clearAllBtn" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Clear All">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Column: Upload & Processing -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- Upload Card -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="upload" class="w-5 h-5 text-indigo-500"></i>
                        Upload Images
                    </h2>
                    <span class="text-xs text-slate-400 font-medium">Max 20 images â€¢ Batch Mode</span>
                </div>
                
                <div class="p-8">
                    <label id="dropZone" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-300 rounded-2xl cursor-pointer bg-slate-50 hover:bg-indigo-50/50 hover:border-indigo-300 transition-all">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <div class="p-3 bg-white rounded-full shadow-sm mb-4">
                                <i data-lucide="image-plus" class="w-8 h-8 text-indigo-500"></i>
                            </div>
                            <p class="mb-2 text-sm text-slate-700">
                                <span class="font-semibold text-indigo-600">Select images</span> or drag & drop
                            </p>
                            <p class="text-xs text-slate-500">PNG, JPG, JPEG (Processes locally)</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" multiple accept="image/*" />
                    </label>

                    <div id="processingSection" class="mt-8 space-y-3 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-slate-700">Queue: <span id="queueCount">0</span> files</h3>
                            <button id="startScanBtn" class="px-5 py-2.5 bg-indigo-600 text-white text-sm font-bold rounded-xl hover:bg-indigo-700 transition-all flex items-center gap-2 shadow-lg shadow-indigo-100 active:scale-95">
                                <i data-lucide="play-circle" class="w-5 h-5"></i>
                                Start Batch Scan
                            </button>
                        </div>
                        
                        <div id="fileList" class="max-h-64 overflow-y-auto space-y-2 pr-2">
                            <!-- File items injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5 text-indigo-500"></i>
                        Extracted Numbers
                    </h2>
                    <div class="flex gap-2">
                        <button id="downloadCsvBtn" class="hidden px-4 py-2 bg-emerald-600 text-white text-sm font-bold rounded-xl hover:bg-emerald-700 transition-all flex items-center gap-2 shadow-md shadow-emerald-100">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Export CSV
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto min-h-[300px]">
                    <table id="resultsTable" class="w-full text-left hidden">
                        <thead class="bg-slate-50/80 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest w-16">ID</th>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mobile Number</th>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Source</th>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest w-20">Action</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody" class="divide-y divide-slate-100">
                            <!-- Results injected here -->
                        </tbody>
                    </table>
                    
                    <div id="emptyState" class="py-24 text-center">
                        <div class="mx-auto w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="file-text" class="text-slate-300 w-8 h-8"></i>
                        </div>
                        <h3 class="text-slate-900 font-semibold">Ready for extraction</h3>
                        <p class="text-slate-500 text-sm mt-1 max-w-xs mx-auto">Upload batch images to extract Indian mobile numbers in 91xxxxxxxxxx format.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Stats & History -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Statistics Card -->
            <div class="bg-indigo-600 rounded-3xl shadow-xl shadow-indigo-200 p-8 text-white relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="text-indigo-100 text-[10px] font-black uppercase tracking-[0.2em] mb-2 opacity-80">Extraction Stats</h3>
                    <div id="totalCount" class="text-6xl font-black mb-1">00</div>
                    <p class="text-indigo-100 text-xs font-medium">Valid Unique Numbers Found</p>
                </div>
                <i data-lucide="cpu" class="absolute -bottom-6 -right-6 w-32 h-32 text-indigo-500 opacity-30"></i>
            </div>

            <!-- App History -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5 text-indigo-500"></i>
                    <h2 class="text-lg font-semibold">History</h2>
                </div>
                <div id="historyList" class="p-4 space-y-3">
                    <p class="text-center py-8 text-sm text-slate-400 italic font-medium">No session history yet</p>
                </div>
            </div>

            <!-- Pro Tip -->
            <div class="bg-amber-50 rounded-2xl p-6 border border-amber-100">
                <div class="flex items-start gap-3">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-amber-500 shrink-0"></i>
                    <div>
                        <h4 class="text-sm font-bold text-amber-900 leading-none">OCR Optimization</h4>
                        <p class="text-xs text-amber-800/80 mt-2 leading-relaxed font-medium">
                            This app uses a Tesseract-powered local engine. High contrast and bright lighting work best for printed or handwritten digits.
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Global Scripts -->
    <script>
        // State Management
        let filesQueue = [];
        let extractedNumbers = new Set();
        let isProcessing = false;
        let downloadCount = parseInt(localStorage.getItem('omniextract_count') || '0');

        // Elements
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const fileList = document.getElementById('fileList');
        const processingSection = document.getElementById('processingSection');
        const queueCount = document.getElementById('queueCount');
        const startScanBtn = document.getElementById('startScanBtn');
        const resultsTable = document.getElementById('resultsTable');
        const resultsBody = document.getElementById('resultsBody');
        const emptyState = document.getElementById('emptyState');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const totalCountDisplay = document.getElementById('totalCount');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const historyList = document.getElementById('historyList');

        // Initialize Lucide
        lucide.createIcons();

        // 1. File Upload Logic
        fileInput.addEventListener('change', handleFiles);
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-indigo-50', 'border-indigo-300'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('bg-indigo-50', 'border-indigo-300'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); handleFiles({ target: { files: e.dataTransfer.files } }); });

        function handleFiles(e) {
            const files = Array.from(e.target.files).slice(0, 20);
            if (files.length === 0) return;

            files.forEach(file => {
                const id = Math.random().toString(36).substr(2, 9);
                filesQueue.push({ id, file, status: 'pending', progress: 0 });
                renderQueueItem(id, file.name, URL.createObjectURL(file));
            });

            updateUI();
        }

        function renderQueueItem(id, name, url) {
            const item = document.createElement('div');
            item.id = `queue-${id}`;
            item.className = "flex items-center gap-4 p-3 bg-white border border-slate-200 rounded-xl transition-all";
            item.innerHTML = `
                <img src="${url}" class="w-12 h-12 object-cover rounded-lg border border-slate-100" />
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-slate-800 truncate">${name}</p>
                    <div id="progress-container-${id}" class="mt-1 hidden">
                        <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                            <div id="progress-bar-${id}" class="progress-bar bg-indigo-600 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <span id="status-${id}" class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Pending</span>
                </div>
                <div id="check-${id}" class="hidden text-emerald-500">
                    <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                </div>
            `;
            fileList.appendChild(item);
            lucide.createIcons();
        }

        function updateUI() {
            if (filesQueue.length > 0) {
                processingSection.classList.remove('hidden');
                queueCount.innerText = filesQueue.length;
            } else {
                processingSection.classList.add('hidden');
            }
            totalCountDisplay.innerText = extractedNumbers.size.toString().padStart(2, '0');
        }

        // 2. OCR Processing Logic
        startScanBtn.addEventListener('click', async () => {
            if (isProcessing || filesQueue.length === 0) return;
            isProcessing = true;
            startScanBtn.disabled = true;
            startScanBtn.innerHTML = '<i class="lucide-loader-2 animate-spin w-5 h-5"></i> Scanning...';

            for (const item of filesQueue) {
                if (item.status === 'completed') continue;

                const statusEl = document.getElementById(`status-${item.id}`);
                const progressContainer = document.getElementById(`progress-container-${item.id}`);
                const progressBar = document.getElementById(`progress-bar-${item.id}`);
                const checkIcon = document.getElementById(`check-${item.id}`);

                progressContainer.classList.remove('hidden');
                statusEl.innerText = 'Processing...';
                statusEl.classList.replace('text-slate-400', 'text-indigo-600');

                try {
                    // Update progress mockly for UI feel
                    progressBar.style.width = '30%';
                    
                    const result = await Tesseract.recognize(item.file, 'eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                progressBar.style.width = `${(m.progress * 100).toFixed(0)}%`;
                            }
                        }
                    });

                    progressBar.style.width = '100%';
                    item.status = 'completed';
                    statusEl.innerText = 'Completed';
                    statusEl.classList.replace('text-indigo-600', 'text-emerald-600');
                    checkIcon.classList.remove('hidden');
                    
                    extractNumbersFromText(result.data.text, item.file.name);
                } catch (err) {
                    console.error(err);
                    item.status = 'error';
                    statusEl.innerText = 'Error';
                    statusEl.classList.replace('text-indigo-600', 'text-red-600');
                }
            }

            isProcessing = false;
            startScanBtn.disabled = false;
            startScanBtn.innerHTML = '<i data-lucide="play-circle" class="w-5 h-5"></i> Start Batch Scan';
            lucide.createIcons();
            updateUI();
        });

        // 3. Extraction & Formatting Logic
        function extractNumbersFromText(text, source) {
            // Indian Mobile Number Regex: Starts with 6-9, 10 digits
            // Handles +91, 91 prefix, spaces, dashes
            const regex = /(?:(?:\+|0{0,2})91[\s-]?)?([6789][\s-]?\d[\s-]?\d[\s-]?\d[\s-]?\d[\s-]?\d[\s-]?\d[\s-]?\d[\s-]?\d[\s-]?\d)/g;
            const matches = text.matchAll(regex);

            let addedCount = 0;
            for (const match of matches) {
                const clean = match[1].replace(/\D/g, '');
                if (clean.length === 10) {
                    const formatted = `91${clean}`;
                    if (!extractedNumbers.has(formatted)) {
                        extractedNumbers.add(formatted);
                        addResultRow(formatted, source);
                        addedCount++;
                    }
                }
            }
            
            if (extractedNumbers.size > 0) {
                emptyState.classList.add('hidden');
                resultsTable.classList.remove('hidden');
                downloadCsvBtn.classList.remove('hidden');
                totalCountDisplay.innerText = extractedNumbers.size.toString().padStart(2, '0');
            }
        }

        function addResultRow(number, source) {
            const row = document.createElement('tr');
            row.className = "hover:bg-slate-50/50 transition-colors group";
            row.innerHTML = `
                <td class="px-6 py-4 text-xs font-bold text-slate-300">#${extractedNumbers.size}</td>
                <td class="px-6 py-4">
                    <span class="text-sm font-bold text-slate-900 font-mono tracking-tight">${number}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="text-[10px] text-slate-400 font-bold uppercase truncate max-w-[150px] block">${source}</span>
                </td>
                <td class="px-6 py-4">
                    <button onclick="copyToClipboard('${number}')" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="Copy">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </td>
            `;
            resultsBody.prepend(row);
            lucide.createIcons();
        }

        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard: ' + text);
            });
        };

        // 4. CSV Export
        downloadCsvBtn.addEventListener('click', () => {
            if (extractedNumbers.size === 0) return;

            downloadCount++;
            localStorage.setItem('omniextract_count', downloadCount);

            const numbers = Array.from(extractedNumbers);
            let csvContent = "data:text/csv;charset=utf-8,ID,Phone Number\n";
            numbers.forEach((num, index) => {
                csvContent += `${index + 1},${num}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const filename = `${downloadCount}.csv`;
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            addToHistory(filename, numbers.length);
        });

        function addToHistory(filename, count) {
            if (historyList.querySelector('p')) historyList.innerHTML = '';
            
            const item = document.createElement('div');
            item.className = "flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100";
            item.innerHTML = `
                <div>
                    <p class="text-xs font-bold text-slate-800">${filename}</p>
                    <p class="text-[9px] font-black text-slate-400 uppercase mt-0.5">${count} items extracted</p>
                </div>
                <div class="text-emerald-500">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                </div>
            `;
            historyList.prepend(item);
            lucide.createIcons();
        }

        // 5. Clear All
        clearAllBtn.addEventListener('click', () => {
            if (confirm('Clear all current queue and extracted data?')) {
                filesQueue = [];
                extractedNumbers.clear();
                fileList.innerHTML = '';
                resultsBody.innerHTML = '';
                resultsTable.classList.add('hidden');
                emptyState.classList.remove('hidden');
                processingSection.classList.add('hidden');
                downloadCsvBtn.classList.add('hidden');
                updateUI();
            }
        });

    </script>
</body>
</html>